<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 设置为UserDao接口方法提供sql语句配置 -->
<mapper namespace="com.onlineShopping.dao.UserDao">
    
    <!-- 搜索商品 -->
    <select id="searchGoods" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT
          g.goodsId,
          g.goodsName,
          g.goodsPrice,
          s.shopName
        FROM goods g
        LEFT JOIN shop s
        ON g.shopId = s.shopId
        WHERE g.goodsName LIKE CONCAT(CONCAT('%',#{searchName}),'%')
    </select>

    <!-- 展示手机专区商品 -->
    <select id="showPhoneAreaGoods" resultType="java.util.Map">
        SELECT
        g.goodsId,
        g.goodsName,
        g.goodsPrice,
        s.shopName
        FROM goods g
        LEFT JOIN shop s
        ON g.shopId = s.shopId
        WHERE g.typeId = 1
        ORDER BY g.goodsUploadTime DESC
    </select>

    <!-- 展示电脑专区商品 -->
    <select id="showComputerAreaGoods" resultType="java.util.Map">
        SELECT
        g.goodsId,
        g.goodsName,
        g.goodsPrice,
        s.shopName
        FROM goods g
        LEFT JOIN shop s
        ON g.shopId = s.shopId
        WHERE g.typeId = 0
        ORDER BY g.goodsUploadTime DESC
    </select>

    <!-- 展示外设专区商品 -->
    <select id="showAccessoryAreaGoods" resultType="java.util.Map">
        SELECT
        g.goodsId,
        g.goodsName,
        g.goodsPrice,
        s.shopName
        FROM goods g
        LEFT JOIN shop s
        ON g.shopId = s.shopId
        WHERE g.typeId = 2
        ORDER BY g.goodsUploadTime DESC
    </select>

    <!-- 低价好货 -->
    <select id="showLowPriceGoods" resultType="java.util.Map">
        SELECT *
        FROM goods
        ORDER BY goodsPrice ASC
    </select>

    <!-- 新上架商品 -->
    <select id="showNewGoods" resultType="java.util.Map">
        SELECT *
        FROM goods
        ORDER BY goodsUploadTime DESC
    </select>

    <!-- 根据商品id查找商品详情(限制两条数据) -->
    <select id="goodsInfo" parameterType="java.lang.Integer" resultType="java.util.Map">
        SELECT
          g.goodsName,
          g.goodsPrice,
          g.shopId,
          s.shopName,
          c.commentTime,
          CASE c.commentStatus
            WHEN 0 THEN c.commentContent
            WHEN 1 THEN '该评论审核未通过'
            ELSE '该评论等待管理员审核'
          END AS commentContent,
          c.userId,
          u.userNickname
        FROM goods g
        LEFT JOIN shop s
        ON g.shopId = s.shopId
        LEFT JOIN comment c
        ON g.goodsId = c.goodsId
        LEFT JOIN user u
        ON c.userId = u.userId
        WHERE g.goodsId = #{goodsId}
        ORDER BY c.commentTime DESC
        LIMIT 0,2
    </select>

    <!-- 根据商品id查找商品评论详情 -->
    <select id="goodsCommentDetail" parameterType="java.lang.Integer" resultType="java.util.Map">
        SELECT
          CASE c.commentStatus
            WHEN 0 THEN c.commentContent
            WHEN 1 THEN '该评论审核未通过'
            ELSE '该评论等待管理员审核'
          END AS commentContent,
          c.commentTime,
          c.userId,
          u.userNickname
        FROM comment c
        LEFT JOIN user u
        ON c.userId = u.userId
        WHERE c.goodsId = #{goodsId}
        ORDER BY c.commentTime DESC
    </select>

    <!-- 检测用户名是否重复 -->
    <select id="isUsernameDuplicate"  parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(username)
        FROM user
        WHERE username = #{username}
    </select>

    <!-- 用户注册 -->
    <insert id="userRegister" parameterType="com.onlineShopping.model.User">
        INSERT INTO user(
          username,
          userPassword,
          userNickname,
          userStatus,
          userBalance,
          userRegisterTime
        ) VALUES (
          #{username},
          #{userPassword},
          #{userNickname},
          "0",
          "0",
          #{userRegisterTime}
        )
    </insert>

    <!-- 用户登录 -->
    <select id="userLogin" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT
          userId,
          userNickname,
          userBalance
        FROM user
        WHERE username = #{username}
        AND userPassword = #{password}
    </select>

    <!-- 用户上传头像 -->
    <update id="uploadUserProfile" parameterType="java.lang.String">
        UPDATE user
        SET userProfile = #{userProfile}
        WHERE userId = #{userId}
    </update>

    <!-- 根据用户id返回用户头像 -->
    <select id="showUserProfile" parameterType="java.lang.Integer" resultType="java.lang.String">
        SELECT userProfile
        FROM user
        WHERE userId = #{userId}
    </select>

    <!-- 根据用户id返回用户信息 -->
    <select id="userInfo" parameterType="java.lang.Integer" resultType="java.util.Map">
        SELECT
          userBalance
        FROM user
        WHERE userId = #{userId}
    </select>

    <!-- 商品评价 -->
    <insert id="goodsComment" parameterType="com.onlineShopping.model.Comment">
        INSERT INTO comment(
          goodsId,
          userId,
          commentContent,
          commentTime
        ) VALUES (
          #{goodsId},
          #{userId},
          #{commentContent},
          #{commentTime}
        )
    </insert>
</mapper>